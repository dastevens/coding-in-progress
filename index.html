<html>
<head>
<title>Coding in Progress</title>
<script>

var storageKey = "coding";
function getCodingHistory() {
	let codingHistoryJson = localStorage.getItem(storageKey) || '[]';
	return JSON.parse(codingHistoryJson);
}

function setCodingHistory(codingHistory) {
	localStorage.setItem(storageKey, JSON.stringify(codingHistory));
}

function padNumber(number) {
    return number.toString().padStart(2, '0');
}

function renderTimeSpan(timeSpanId, elapsedMilliseconds) {
	let elapsedSeconds = elapsedMilliseconds / 1000;
	let elapsedMinutes = elapsedSeconds / 60;
	let elapsedHours = elapsedMinutes / 60;
    let timeSpan = padNumber(Math.floor(elapsedHours)) + ':' +
        padNumber(Math.floor(elapsedMinutes) % 60) + ':' +
        padNumber(Math.floor(elapsedSeconds) % 60);
    document.getElementById(timeSpanId, timeSpan).innerHTML = timeSpan;
}

function updateBody() {
	let codingHistory = getCodingHistory();
	if (codingHistory.length > 0) {
		let mostRecentEvent = getCodingHistory()[0];
        document.title = mostRecentEvent.event;
		document.getElementById('body').className = mostRecentEvent.event;

		let elapsedMilliseconds = Date.now() - mostRecentEvent.timestamp;
		renderTimeSpan('elapsed', elapsedMilliseconds);
		let start = Date.now();
		renderTimeSpan('last-15-minutes', totalCoding(start - 15 * 60 * 1000, Date.now()));
		renderTimeSpan('last-30-minutes', totalCoding(start - 30 * 60 * 1000, Date.now()));
		renderTimeSpan('last-hour', totalCoding(start - 60 * 60 * 1000, Date.now()));
		start = new Date(start);
		start.setHours(0, 0, 0, 0);
		start = start.getTime();
		renderTimeSpan('today', totalCoding(start, Date.now()));
		start = new Date(start);
		start.setDate(start.getDate() - start.getDay())
		start = start.getTime();
		renderTimeSpan('this-week', totalCoding(start, Date.now()));
	}
}

function totalCoding(start, end) {
	let codingHistory = [{event:'Stop', timestamp: end}].concat(getCodingHistory());
	let totalCoding = 0;
	for (let i = 1; i < codingHistory.length; i++) {
		let item = codingHistory[i - 1];
		let last = codingHistory[i];
		let from = Math.min(end, Math.max(start, last.timestamp));
		let to = Math.min(end, Math.max(start, item.timestamp));
		if (last.event == 'Start') {
			totalCoding += to - from;
		}
	}
	return totalCoding;
}

function addItem(event) {
	let codingHistory = getCodingHistory();
	let item = {event: event, timestamp: Date.now()};
	if (codingHistory.length === 0 || codingHistory[0].event !== event) {
		let updatedHistory = [item].concat(codingHistory);
		setCodingHistory(updatedHistory);
		updateBody();
	}
}

function startCoding() {
	addItem('Start');
}

function stopCoding() {
	addItem('Stop');
}

function loaded() {
	addItem('Stop');
	setInterval(updateBody, 1000);
}

function unloaded() {
	addItem('Stop');
}

</script>

<style>
body.start #start,
body.start .stop,
body.stop #stop,
body.stop .start {
	display: none;
}
</style>
</head>
<body id="body" class="Stop" onload="loaded()" onunload="unloaded()">
    <button id="start" onclick="startCoding()">Start</button>
    <button id="stop" onclick="stopCoding()">Stop</button>
    <p id="elapsed">
            00:00:00
    </p>
    <img class="start" src="start.png"/>
    <img class="stop" src="stop.jpg"/>
    <table>
        <tr>
            <th>Last 15 minutes</th>
            <td id="last-15-minutes">
                00:00:00
            </td>
        </tr>
        <tr>
            <th>Last 30 minutes</th>
            <td id="last-30-minutes">
                00:00:00
            </td>
        </tr>
        <tr>
            <th>Last hour</th>
            <td id="last-hour">
                00:00:00
            </td>
        </tr>
        <tr>
            <th>Today</th>
            <td id="today">
                00:00:00
            </td>
        </tr>
        <tr>
            <th>This week</th>
            <td id="this-week">
                00:00:00
            </td>
        </tr>
    </table>
</body>
</html>